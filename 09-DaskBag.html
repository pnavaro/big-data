

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dask bag &#8212; Python tools for Big data</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://pnavaro.github.io/big-data/09-DaskBag.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Pandas Series" href="10-PandasSeries.html" />
    <link rel="prev" title="Dask" href="08-DaskDelayed.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">


<!-- Opengraph tags -->
<meta property="og:url"         content="https://pnavaro.github.io/big-data/09-DaskBag.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Dask bag" />
<meta property="og:description" content="Dask bag  Dask proposes “big data” collections with a small set of high-level primitives like map, filter, groupby, and join.  With these common patterns we can" />
<meta property="og:image"       content="https://pnavaro.github.io/big-data/_static/logoR2-Noir.png" />

<meta name="twitter:card" content="summary" />


  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  <img src="_static/logoR2-Noir.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Python tools for Big data</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="01-GitBasics.html">
   Git basics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02-Installation.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03-JupyterQuickStart.html">
   Jupyter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04-WordCount.html">
   Wordcount
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05-MapReduce.html">
   Map Reduce
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06-ParallelComputation.html">
   Parallel Computation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07-AsynchronousProcessing.html">
   Asynchronous Processing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08-DaskDelayed.html">
   Dask
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Dask bag
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10-PandasSeries.html">
   Pandas Series
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11-PandaDataframes.html">
   Pandas Dataframes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12-PySpark.html">
   PySpark
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13-UnixCommands.html">
   Basic Commands in the Unix Shell
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14-Hadoop.html">
   Hadoop
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15-HadoopFileFormats.html">
   Hadoop File Formats
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16-DaskDataframes.html">
   Dask Dataframes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="17-SparkDataFrames.html">
   Spark DataFrames
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="18-NYCTaxiCabTripDask.html">
   Dask dataframes on HDFS
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="19-NYCTaxiCabTripSpark.html">
   Spark dataframes on HDFS
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/09-DaskBag.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/pnavaro/big-data"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/pnavaro/big-data/issues/new?title=Issue%20on%20page%20%2F09-DaskBag.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/pnavaro/big-data/edit/master/notebooks/09-DaskBag.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/pnavaro/big-data/master?urlpath=tree/notebooks/09-DaskBag.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/pnavaro/big-data/blob/master/notebooks/09-DaskBag.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#daily-stock-example">
   Daily stock example
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#serial-version">
     Serial version
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dask-bag-methods">
   Dask.bag methods
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#wordcount-with-dask-bag">
     Wordcount with Dask bag
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#genome-example">
   Genome example
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-9-1">
     Exercise 9.1
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-9-2">
     Exercise 9.2
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-9-3">
     Exercise 9.3
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#some-remarks-about-bag">
   Some remarks about bag
  </a>
 </li>
</ul>

        </nav>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="dask-bag">
<h1>Dask bag<a class="headerlink" href="#dask-bag" title="Permalink to this headline">¶</a></h1>
<p>Dask proposes “big data” collections with a small set of high-level primitives like <code class="docutils literal notranslate"><span class="pre">map</span></code>, <code class="docutils literal notranslate"><span class="pre">filter</span></code>, <code class="docutils literal notranslate"><span class="pre">groupby</span></code>, and <code class="docutils literal notranslate"><span class="pre">join</span></code>.  With these common patterns we can often handle computations that are more complex than map, but are still structured.</p>
<ul class="simple">
<li><p>Dask-bag excels in processing data that can be represented as a sequence of arbitrary inputs (“messy” data)</p></li>
<li><p>When you encounter a set of data with a format that does not enforce strict structure and datatypes.</p></li>
</ul>
<p><strong>Related Documentation</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="http://dask.pydata.org/en/latest/bag.html">Bag Documenation</a></p></li>
<li><p><a class="reference external" href="http://dask.pydata.org/en/latest/bag-api.html">Bag API</a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 4, 5, 6, 7, 8]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask.bag</span> <span class="k">as</span> <span class="nn">db</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">from_sequence</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>  <span class="c1"># Gather results back to local process</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 4, 5, 6, 7, 8]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span> <span class="c1"># compute length of each element and collect results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 1, 1, 2, 2, 3, 3, 4]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="k">def</span> <span class="nf">slow_half</span><span class="p">(</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">//</span> <span class="mi">2</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">slow_half</span><span class="p">)</span>
<span class="n">res</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dask.bag&lt;slow_half, npartitions=8&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">res</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 18.5 ms, sys: 13.6 ms, total: 32.1 ms
Wall time: 4.38 s
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 1, 1, 2, 2, 3, 3, 4]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/09-DaskBag_7_0.png" src="_images/09-DaskBag_7_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="o">.</span><span class="n">topk</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;bound method Bag.topk of dask.bag&lt;from_sequence, npartitions=8&gt;&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span> <span class="c1"># Cartesian product of each pair </span>
<span class="c1"># of elements in two sequences (or the same sequence in this case)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(1, 1),
 (1, 2),
 (1, 3),
 (1, 4),
 (1, 5),
 (1, 6),
 (1, 7),
 (1, 8),
 (2, 1),
 (2, 2),
 (2, 3),
 (2, 4),
 (2, 5),
 (2, 6),
 (2, 7),
 (2, 8),
 (3, 1),
 (3, 2),
 (3, 3),
 (3, 4),
 (3, 5),
 (3, 6),
 (3, 7),
 (3, 8),
 (4, 1),
 (4, 2),
 (4, 3),
 (4, 4),
 (4, 5),
 (4, 6),
 (4, 7),
 (4, 8),
 (5, 1),
 (5, 2),
 (5, 3),
 (5, 4),
 (5, 5),
 (5, 6),
 (5, 7),
 (5, 8),
 (6, 1),
 (6, 2),
 (6, 3),
 (6, 4),
 (6, 5),
 (6, 6),
 (6, 7),
 (6, 8),
 (7, 1),
 (7, 2),
 (7, 3),
 (7, 4),
 (7, 5),
 (7, 6),
 (7, 7),
 (7, 8),
 (8, 1),
 (8, 2),
 (8, 3),
 (8, 4),
 (8, 5),
 (8, 6),
 (8, 7),
 (8, 8)]
</pre></div>
</div>
</div>
</div>
<p>Chain operations to construct more complex computations</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
  <span class="o">.</span><span class="n">filter</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">v</span> <span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="o">.</span><span class="n">compute</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(3, 1), (5, 1), (7, 1)]
</pre></div>
</div>
</div>
</div>
<div class="section" id="daily-stock-example">
<h2>Daily stock example<a class="headerlink" href="#daily-stock-example" title="Permalink to this headline">¶</a></h2>
<p>Let’s use the bag interface to read the json files containing time series.</p>
<p>Each line is a JSON encoded dictionary with the following keys</p>
<ul class="simple">
<li><p>timestamp: Day.</p></li>
<li><p>close: Stock value at the end of the day.</p></li>
<li><p>high: Highest value.</p></li>
<li><p>low: Lowest value.</p></li>
<li><p>open: Opening price.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># preparing data</span>
<span class="kn">import</span> <span class="nn">os</span>  <span class="c1"># library to get directory and file paths</span>
<span class="kn">import</span> <span class="nn">tarfile</span> <span class="c1"># this module makes possible to read and write tar archives</span>

<span class="k">def</span> <span class="nf">extract_data</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datadir</span><span class="p">):</span>
       <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting data...&quot;</span><span class="p">)</span>
       <span class="n">tar_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;.tgz&#39;</span><span class="p">)</span>
       <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tar_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r:gz&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
          <span class="n">data</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">where</span><span class="p">)</span>
            
<span class="n">extract_data</span><span class="p">(</span><span class="s1">&#39;daily-stock&#39;</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="c1"># this function call will extract json files</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">ls</span> data/daily-stock/*.json
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data/daily-stock/aet.json   data/daily-stock/hpq.json
data/daily-stock/afl.json   data/daily-stock/ibm.json
data/daily-stock/aig.json   data/daily-stock/jbl.json
data/daily-stock/al.json    data/daily-stock/jpm.json
data/daily-stock/amgn.json  data/daily-stock/luv.json
data/daily-stock/avy.json   data/daily-stock/met.json
data/daily-stock/b.json     data/daily-stock/pcg.json
data/daily-stock/bwa.json   data/daily-stock/tgt.json
data/daily-stock/ge.json    data/daily-stock/usb.json
data/daily-stock/hal.json   data/daily-stock/xom.json
data/daily-stock/hp.json
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask.bag</span> <span class="k">as</span> <span class="nn">db</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="n">stocks</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="s1">&#39;data/daily-stock/*.json&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks</span><span class="o">.</span><span class="n">npartitions</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/09-DaskBag_17_0.png" src="_images/09-DaskBag_17_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="n">js</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="c1"># get the current directory</span>
<span class="n">filenames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;daily-stock&#39;</span><span class="p">,</span> <span class="s1">&#39;*.json&#39;</span><span class="p">)))</span>
<span class="n">filenames</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/aet.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/afl.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/aig.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/al.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/amgn.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/avy.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/b.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/bwa.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/ge.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/hal.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/hp.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/hpq.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/ibm.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/jbl.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/jpm.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/luv.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/met.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/pcg.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/tgt.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/usb.json&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/xom.json&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">rm</span> data/daily-stock/*.h5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
        
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="n">out_filename</span> <span class="o">=</span> <span class="n">fn</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span> <span class="s1">&#39;/data&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "f311ebb5dbc54482a6f87fdb9887ece2"}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filenames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;daily-stock&#39;</span><span class="p">,</span> <span class="s1">&#39;*.h5&#39;</span><span class="p">)))</span>
<span class="n">filenames</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/aet.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/afl.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/aig.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/al.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/amgn.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/avy.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/b.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/bwa.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/ge.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/hal.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/hp.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/hpq.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/ibm.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/jbl.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/jpm.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/luv.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/met.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/pcg.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/tgt.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/usb.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/xom.h5&#39;]
</pre></div>
</div>
</div>
</div>
<div class="section" id="serial-version">
<h3>Serial version<a class="headerlink" href="#serial-version" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">series</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>   <span class="c1"># Simple map over filenames</span>
    <span class="n">series</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>    <span class="c1"># Doubly nested loop over the same collection</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>  
        <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">:</span>     <span class="c1"># Filter out bad elements</span>
            <span class="n">results</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">series</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>  <span class="c1"># Apply function</span>

<span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">corr</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Reduction</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 873 ms, sys: 63.4 ms, total: 936 ms
Wall time: 936 ms
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">corr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/aet.h5&#39;,
 &#39;/home/runner/work/big-data/big-data/notebooks/data/daily-stock/luv.h5&#39;,
 0.9413176064560881)
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="dask-bag-methods">
<h2>Dask.bag methods<a class="headerlink" href="#dask-bag-methods" title="Permalink to this headline">¶</a></h2>
<p>We can construct most of the above computation with the following dask.bag methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">collection.map(function)</span></code>: apply function to each element in collection</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collection.product(collection)</span></code>: Create new collection with every pair of inputs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collection.filter(predicate)</span></code>: Keep only elements of colleciton that match the predicate function</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collection.max()</span></code>: Compute maximum element</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="kn">import</span> <span class="nn">dask.bag</span> <span class="k">as</span> <span class="nn">db</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">from_sequence</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
<span class="n">series</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fn</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>

<span class="n">corr</span> <span class="o">=</span> <span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
              <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ab</span><span class="p">:</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ab</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
              <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ab</span><span class="p">:</span> <span class="n">ab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 3.41 ms, sys: 4.07 ms, total: 7.49 ms
Wall time: 7.26 ms
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 2.28 s, sys: 2.02 s, total: 4.3 s
Wall time: 6.48 s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9413176064560881
</pre></div>
</div>
</div>
</div>
<div class="section" id="wordcount-with-dask-bag">
<h3>Wordcount with Dask bag<a class="headerlink" href="#wordcount-with-dask-bag" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">lorem</span>

<span class="n">lorem</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Porro dolorem sed sit sed adipisci neque. Dolor neque dolor dolorem labore eius. Numquam ut dolorem numquam amet velit adipisci. Adipisci ipsum voluptatem non ut labore. Adipisci quaerat amet neque neque etincidunt dolor. Ut neque dolor consectetur tempora consectetur quaerat sed.\n\nSed amet ut sit tempora. Non etincidunt dolor aliquam etincidunt velit. Aliquam etincidunt amet quiquia non aliquam ipsum. Etincidunt velit amet velit quisquam neque etincidunt. Dolore dolorem est eius eius tempora tempora dolor. Tempora dolorem quaerat aliquam tempora modi dolore eius.\n\nModi amet sit ut. Magnam tempora dolor ut dolorem. Ut adipisci tempora porro. Porro amet ipsum numquam quiquia eius dolorem ut. Neque aliquam amet porro quisquam labore amet ut. Consectetur dolore ut quaerat consectetur dolore voluptatem eius.\n\nNumquam etincidunt voluptatem dolore. Dolore sed porro numquam quaerat quisquam. Amet numquam labore magnam dolor. Numquam neque quiquia etincidunt voluptatem dolor. Non est dolor modi ipsum dolor quiquia tempora.&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">lorem</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sample</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lorem</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">ls</span> *.txt
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sample.txt    sample04.txt  sample09.txt  sample14.txt  sample19.txt
sample00.txt  sample05.txt  sample10.txt  sample15.txt
sample01.txt  sample06.txt  sample11.txt  sample16.txt
sample02.txt  sample07.txt  sample12.txt  sample17.txt
sample03.txt  sample08.txt  sample13.txt  sample18.txt
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span>
<span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;sample*.txt&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;sample13.txt&#39;,
 &#39;sample00.txt&#39;,
 &#39;sample06.txt&#39;,
 &#39;sample09.txt&#39;,
 &#39;sample15.txt&#39;,
 &#39;sample.txt&#39;,
 &#39;sample08.txt&#39;,
 &#39;sample03.txt&#39;,
 &#39;sample14.txt&#39;,
 &#39;sample17.txt&#39;,
 &#39;sample04.txt&#39;,
 &#39;sample18.txt&#39;,
 &#39;sample07.txt&#39;,
 &#39;sample01.txt&#39;,
 &#39;sample19.txt&#39;,
 &#39;sample16.txt&#39;,
 &#39;sample10.txt&#39;,
 &#39;sample12.txt&#39;,
 &#39;sample05.txt&#39;,
 &#39;sample02.txt&#39;,
 &#39;sample11.txt&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask.bag</span> <span class="k">as</span> <span class="nn">db</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;sample*.txt&#39;</span><span class="p">))</span>

<span class="n">wordcount</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># remove dots</span>
             <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>           <span class="c1"># lower text</span>
             <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>           <span class="c1"># remove \n and trailing spaces</span>
             <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>           <span class="c1"># split into words</span>
             <span class="o">.</span><span class="n">flatten</span><span class="p">()</span>             <span class="c1"># chain all words lists</span>
             <span class="o">.</span><span class="n">frequencies</span><span class="p">()</span>         <span class="c1"># compute occurences</span>
             <span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># sort and return top 10 words</span>


<span class="n">wordcount</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span> <span class="c1"># Run all tasks and return result</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;porro&#39;, 75034),
 (&#39;ipsum&#39;, 74907),
 (&#39;velit&#39;, 74855),
 (&#39;consectetur&#39;, 74846),
 (&#39;voluptatem&#39;, 74613),
 (&#39;amet&#39;, 74603),
 (&#39;quisquam&#39;, 74600),
 (&#39;numquam&#39;, 74596),
 (&#39;quaerat&#39;, 74563),
 (&#39;quiquia&#39;, 74510)]
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="genome-example">
<h2>Genome example<a class="headerlink" href="#genome-example" title="Permalink to this headline">¶</a></h2>
<p>We will use a Dask bag to calculate the frequencies of sequences of five bases, and then sort the sequences into descending order ranked by their frequency.</p>
<ul class="simple">
<li><p>First we will define some functions to split the bases into sequences of a certain size</p></li>
</ul>
<div class="section" id="exercise-9-1">
<h3>Exercise 9.1<a class="headerlink" href="#exercise-9-1" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Implement a function <code class="docutils literal notranslate"><span class="pre">group_characters(line,</span> <span class="pre">n=5)</span></code> to group <code class="docutils literal notranslate"><span class="pre">n</span></code> characters together and return a iterator. <code class="docutils literal notranslate"><span class="pre">line</span></code> is a text line in genome.txt file.</p></li>
</ul>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;abcdefghijklmno&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">group_character</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
<span class="go">        print(seq)</span>
<span class="go">        </span>
<span class="go">&quot;abcde&quot;</span>
<span class="go">&quot;efghi&quot;</span>
<span class="go">&quot;klmno&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">group_and_split(line)</span></code></p></li>
</ul>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">group_and_split</span><span class="p">(</span><span class="s1">&#39;abcdefghijklmno&#39;</span><span class="p">)</span>
<span class="go">[&#39;abcde&#39;, &#39;fghij&#39;, &#39;klmno&#39;]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Use the dask bag to compute  the frequencies of sequences of five bases.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;abcdefghijklmno&quot;</span>
<span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">group_character</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">31</span><span class="o">-</span><span class="mi">81</span><span class="n">a78c10163f</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;abcdefghijklmno&quot;</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">group_character</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="nb">print</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;group_character&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>

<span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span><span class="s2">&quot;genome.txt&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">g</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;genome</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">glob</span><span class="p">(</span><span class="s2">&quot;data/genome0*.txt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;data/genome01.txt&#39;,
 &#39;data/genome00.txt&#39;,
 &#39;data/genome02.txt&#39;,
 &#39;data/genome03.txt&#39;,
 &#39;data/genome07.txt&#39;,
 &#39;data/genome06.txt&#39;,
 &#39;data/genome04.txt&#39;,
 &#39;data/genome05.txt&#39;]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="exercise-9-2">
<h3>Exercise 9.2<a class="headerlink" href="#exercise-9-2" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="http://www.cbs.dtu.dk/services/NetGene2/fasta.php">FASTA</a> file format is used to write several genome sequences.</p>
<ul class="simple">
<li><p>Create a function that can read a <span class="xref myst">FASTA file</span> and compute the frequencies for n = 5 of a given sequence.</p></li>
</ul>
</div>
<div class="section" id="exercise-9-3">
<h3>Exercise 9.3<a class="headerlink" href="#exercise-9-3" title="Permalink to this headline">¶</a></h3>
<p>Write a program that uses the function implemented above to read several FASTA files stored in a Dask bag.</p>
</div>
</div>
<div class="section" id="some-remarks-about-bag">
<h2>Some remarks about bag<a class="headerlink" href="#some-remarks-about-bag" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Higher level dask collections include functions for common patterns</p></li>
<li><p>Move data to collection, construct lazy computation, trigger at the end</p></li>
<li><p>Use Dask.bag (<code class="docutils literal notranslate"><span class="pre">product</span> <span class="pre">+</span> <span class="pre">map</span></code>) to handle nested for loop</p></li>
</ul>
<p>Bags have the following known limitations</p>
<ol class="simple">
<li><p>Bag operations tend to be slower than array/dataframe computations in the
same way that Python tends to be slower than NumPy/Pandas</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Bag.groupby</span></code> is slow.  You should try to use <code class="docutils literal notranslate"><span class="pre">Bag.foldby</span></code> if possible.</p></li>
<li><p>Check the <a class="reference external" href="http://dask.pydata.org/en/latest/bag-api.html">API</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dask.dataframe</span></code> can be faster than <code class="docutils literal notranslate"><span class="pre">dask.bag</span></code>.  But sometimes it is easier to load and clean messy data with a bag. We will see later how to transform a bag into a <code class="docutils literal notranslate"><span class="pre">dask.dataframe</span></code> with the <a class="reference external" href="http://dask.pydata.org/en/latest/bag-api.html#dask.bag.Bag.to_dataframe">to_dataframe</a> method.</p></li>
</ol>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "pnavaro/big-data",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "big-data"
        },
        kernelOptions: {
            kernelName: "big-data",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'big-data'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="08-DaskDelayed.html" title="previous page">Dask</a>
    <a class='right-next' id="next-link" href="10-PandasSeries.html" title="next page">Pandas Series</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Pierre Navaro<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="_static/js/index.js"></script>
    
  </body>
</html>